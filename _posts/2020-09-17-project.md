---
layout: post
title: VUE+SpringBoot前后端分离部署笔记
date: 2020-09-17
Author: hhw
toc: true
comments: true
tags:  [部署]
---

# 项目部署流程

- 简介：RuoYi 开源框架部署为例
- CentenOS 6
- SpringBoot打War包
- JDK1.8
- Tomcat 9
- vue+springboot前后端分离部署方案
- mysql 5.7
- redis-3.2.3

## 1.linux基础配置

### 1.检查配置环境

#### 1.1 JDK

这里以JDK1.8为例进行配置

**检查当前JDK版本**

```
java -version
```

**升级JDK版本**

```
yum install java-1.8.0-openjdk* -y
```

使用yum命令安装后无需配置，安装完后需要检查jdk环境是否更新

#### 1.2 Tomcat

**下载Tomcat**

去[官网](https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.36/bin/)下载包，可以wget直接下载或下载完后拷贝到linux

> wget

```bash
wget https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.41/bin/apache-tomcat-8.5.41.tar.gz  
// 以tomcat 8 为例，根据实际情况更换版本
```

> 拷贝

使用 scp 命令传输到linux虚拟机中，直接使用终端命令即可：

```bash
scp -P 22 /Users/hhw/Downloads/apache-tomcat-9.0.36.tar.gz root@10.211.55.4:/project/tomcat9
```

- 端口大写P 为参数，22 表示更改SSH端口后的端口，如果没有更改SSH端口可以不用添加该参数。 

- `/Users/hhw/Downloads/apache-tomcat-9.0.36.tar.gz  `表示本地上准备上传文件的路径和文件名。

- root@123.456.789.987 表示使用root用户登录远程服务器。

- :/usr/server/tomcat7/webapps/ 表示保存在远程服务器上目录和文件名。

- 拷贝文件夹使用`scp -r`

  


**解压Tomcat**

cd到tomcat包目录，执行解压：

```bash
tar -zxvf apache-tomcat-9.0.36.tar.gz 
```

cd到tomcat的bin目录下，测试启动tomcat，执行命令，出现启动标识：

```
./startup.sh  开启
./shutdown.sh  关闭
```

![image-20200723141645361](https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152524.png)



**检查是否启动成功**

1.先去看tomcat查看日志是否启动成功：

去`logs/catalina.out `看日志，主要看最后一行是否启动成功即可；

```bash
tail -f catalina.out 		实时查看日志
tail -n 200 -f catalina.out 	实时查看日志 最后N行
```

2.linux本机测试访问tomcat是否成功，执行命令：

```bash
 curl 10.211.55.4:8080
```

如果能访问到网页，那么证明执行成功。

![image-20200723143450318](https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152529.png)



**测试远端访问Linux的Tomcat**

如果本机无法访问，检查端口防火墙是否打开

**第一步：**执行指令：

```bash
vim /etc/sysconfig/iptables	
```

<u>添加8080端口号配置</u>，默认只有22端口，一定要配置在

`-A INPUT -j REJECT --reject-with icmp-host-prohibited`
`-A FORWARD -j REJECT --reject-with icmp-host-prohibited`
这两行之前才能生效。如图：

![image-20200723143900491](https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152534.png)

**第二步：**重启防火墙，执行：

```bash
service iptables restart 
```

浏览器输入linux的tomcat地址，这里是http://10.211.55.4:8080/，成功访问！

#### 1.3 Nginx(废弃)

**创建nginx.repo**

执行：

```bash
vim  /etc/yum.repos.d/nginx.repo
```

文件内容要求如下，注意版本，数字位置位版本：

```bash
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/6/$basearch/
gpgcheck=0
enabled=1
```

**清除缓存**

```bash
yum clean all
```

 建立新的缓存

```bash
yum makecache
```

**安装**

```bash
yum -y install nginx
```

如下表示成功：

![image-20200723151729197](2020-09-17-project.assets/image-20200723151729197.png)

**检查/启动**

执行命令检查是否安装成功：

```bash
rpm -q nginx
```

启动：

```bash
service nginx start
```

查看安装以及配置文件目录：

```bash
ps -aef|grep nginx
```

之后根据环境进行具体配置即可！

配置完后检查配置文件是否正确：

```bash
nginx -t
```

配置完成后重启：

```bash
nginx -s reload
```

nginx关闭指令

`sudo nginx -s quit`

<u>*记得打开防火墙外面才能访问*</u>



#### 1.4 MySQL

cd到要存放的目录下：

**检查是否已安装**

```bash
rpm -qa | grep MySQL
或
rpm -qa | grep mysql
```

**yum安装mysql**

更新wget：

```bash
wget --no-check-certificate  http://dev.mysql.com/get/mysql57-community-release-el6-7.noarch.rpm
```

安装完后查看源情况：

```bash
yum repolist enabled
```

看见 MySQL 5.7 Community Server  就可以

查看下mysql的版本：

```bash
yum list mysql-community*
```

<u>安装最新版本：</u>

```bash
yum -y install mysql-server
```

**启动**

```bash
[root@mysql2 ~]# service mysqld start
Initializing MySQL database:                               [FAILED]
[root@mysql2 ~]# service mysqld start
Starting mysqld:                                           [  OK  ]
```

停止：`service mysqld stop`

**修改密码**

<u>查看默认密码</u>：

```bash
grep 'temporary password' /var/log/mysqld.log
```

最后一串就是默认密码。

进入mysql命令行，输入默认密码即可进入：

```bash
mysql -uroot -p
```

更改密码：

```bash
set password for root@localhost = password('密码');
```

**开启外部访问**

```bash
grant all on *.* to  root@"%" Identified by "密码"; //开启root用户外部登陆
FLUSH PRIVILEGES;
```

Mysql下表名区分大小写，可能项目启动会因此报错，可以通过修改配置文件解决。

#### 1.5 Redis

**安装**

cd到存放Redis的目录下：

```bash
$ wget http://download.redis.io/releases/redis-3.2.3.tar.gz
$ tar xzf redis-3.2.3.tar.gz
$ cd redis-3.2.3
$ make
```

**启动**

启动redis。进入/usr/local/redis的bin目录，执行：
`./redis-server`

**make命令报错解决方法：**

安装C++编译器：

```bash
yum -y install gcc-c++
```

若还是出错，则执行：

```bash
$ make clean  
$ make
```

再检查redis-x.x.x/src 目录下有没有 redis-server、redis-cli 和 /usr/local/bin下有没有

若无，则把redis-x.x.x 文件夹删掉，再解压一次redis的压缩包，cd进入 redis-x.x.x 中， make 一下 即可

**配置外网访问与后台常驻**

外网访问：

更改redis.conf 配置文件 由

```properties
bind 127.0.0.1 
protected-mode yes
```

 更改为：

```properties
# bind 127.0.0.1
protected-mode no
```

设置常驻：

```properties
daemonize yes
```

**以配置文件启动：**

```bash
redis-server redis.conf
```

#### 1.6 node.js

（不需要）

**第一步** 下载node.js

cd到安装目录下，使用wget下载node.js

```shell
cd /project/node
wget http://nodejs.org/dist/v0.10.26/node-v0.10.26.tar.gz
```

**第二步** 编译

需要保证python版本在2.6以上，查看python版本

```shell
python --version
// 2.6.6
```

编译

```shell
./configure --prefix=/usr/local/node/v0.10.26
make
make install
```

--prefix  可以把所有资源文件放在/usr/local/node/v0.10.26的路径中，

**第三步** 配置环境变量

修改之前先进行备份

```shell
cp /etc/profile /etc/profile.bak
```

vim编辑

```shell
vim /etc/profile
```

在文件最后加入

```
export NODE_HOME=/usr/local/node/v0.10.26
export PATH=$NODE_HOME/bin:$PATH
export NODE_PATH=$NODE_HOME/lib/node_modules:$PATH
```

保存退出之后，执行如下命令让配置立即生效

```
source /etc/profile
```

**第四步** 验证是否安装成功

```
node -v
// v0.10.26
```

#### 1.7Nginx（新）

> 使用编译的方式安装nginx

**卸载**

linux有一系列的软件管理器，比如常见的linux下的yum、Ubuntu下的apt-get等等。通过这些软件管理器可以很快的卸载软件，并且不会有文件及配置残留。这里我使用的是yum，命令如下:

```
yum remove nginx
```

**安装**

cd到要存放的目录下，下载并解压安装包

```shell
wget http://nginx.org/download/nginx-1.13.7.tar.gz
tar -xvf nginx-1.13.7.tar.gz
```

**编译**

```
./configure --prefix=/project/nginx-1.13.7
make
make install
```

注：--prefix=[需要安装到的路径]

⚠️ make时报错：`*** 没有规则可以创建“default”需要的目标“build`，原因是缺少依赖保，执行依赖包安装语句：

`yum install pcre-devel zlib zlib-devel openssl openssl-devel`

依赖包安装完成后，需要重新执行`./configure`语句

**运行**

cd到刚才安装的路径下，可以看到目录下有四个文件夹

```
cd /project/nginx-1.13.7
```

<img src="https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917114622.png" alt="image-20200917114605910" style="zoom:50%;" />

cd到sbin下，执行

```shell
./nginx
```

**使用此种方式安装，执行nginx命令都需要到此sbin文件夹下执行，无法全局执行**

**且执行命令方式例如：** `./nginx -t` `./nginx -s reload`

查看端口占用情况

```
netstat -antp
```

可以看到80端口被nginx占用，此时访问本地80端口，会出现nginx的欢迎页面

配置文件在conf文件夹中，可自行更改

## 2.SpringBoot打包

> **以打war包部署到外部Tomcat为例子**

> 打包前注意referer添加一个服务器的ip地址

**步一：pom.xml修改**

**`pom.xml`中把`jar`改成`war`**

```xml
<packaging>war</packaging>
```

**步二：排除内嵌Tomcat**

> 因为这里RuoYi项目已经通过继承`SpringBootServletInitializer`重写`SpringApplicationBuilder`方法来排除内置Tomcat，所以pom文件不需要额外改动
>
> *如果启动类没有修改，那么需要在pom文件中排除tomcat

**步三：启用打包程序**

IDEA：先clean-->再package

![image-20200723204213250](https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152554.png)

完成后会显示成功，并且war包会在target目录。

**步四：部署**

将war包放在tomcat的webapps目录下，启动tomcat即可。注意查看日志。

查看tomcat进程：

```bash
ps -ef | grep tomcat
```

访问路径为 **ip:tomcat端口号/项目名称(war包名称)**

示例：(http://10.211.55.4:8088/ruoyi-admin/index)

**步五：配置nginx**

项目启动成功后，需要设置nginx，解决前后端分离的跨域问题；

如下，为该后端项目配置一个代理

<img src="https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917150018.png" alt="image-20200917150015143" style="zoom:50%;" />

```
  location /prod-api {
  	proxy_pass http://127.0.0.1:8088/terton-dolphin-project;
  }
```

⚠️ 需要附上项目包名才能成功代理，配置完成后，重启nginx，成功代理。



## 3.vue打包部署

**打包**

cd到项目跟路径下，执行

```
npm install
```

执行完成后，在执行

```
npm run build
```

⚠️ 如果报错，出现`npm ERR! missing script: build` ，进入package.json中`scripts`，查看到参数为：`"build:prod": "vue-cli-service build"`,那么更改执行命令为:

```
npm run build:prod --report
```

打包成功后在项目目录下会生成<u>dist</u>文件夹

**部署到Nginx**

将生成的dist文件放到nginx的html文件夹下，修改nginx配置文件

先备份配置文件：

```
cp ./nginx.conf ./nginx.conf.bak
```

修改配置文件示例：在80端口添加如下两个配置，这里是在80端口部署2个vue项目

```xml
location /console {
  alias   html/dist;		# 项目打包生成的dist文件夹
  index  index.html index.htm;
  try_files $uri $uri/ /console/index.html;		# 首页
}

location /project {
  alias   html/dist2;	 # 项目打包生成的dist文件夹
  index index.html index.htm;
  try_files $uri $uri/ /project/index.html;		# 首页
}
```

完整截图，只改动红框内，其他不需要变动：

<img src="https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917142827.png" alt="image-20200917142818397" style="zoom:50%;" />

**重新启动nginx**

在nginx/sbin目录下

```
./nginx -s reload
```

访问 ip/[刚才配置的路径]	即可跳转成功



## 4.Docker

【以后的项目安装都基于docker，而不是采用上述的单独分离安装，docker版本部署正在研究中.....】

### 1.安装docker

**步骤一：检查cenos内核版本，必须为64位系统且系统内核>=3.1**

```cmd
uname -r
```

<img src="https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152613.png" alt="image-20200916142949269" style="zoom:50%;" />

**步骤二：yum安装docker**

先检查是否已经安装

```
yum list installed | grep docker
```

若无内容表示未安装

使用yum安装

```
yum -y install docker
```

-y表示不询问安装，直到安装成功，安装完后再次查看安装列表

安装完毕后，再次查看安装列表会出现：

![image-20200916143140783](https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152606.png)

**步骤三：启动docker**

```
systemctl start docker
```

**步骤四：查看docker服务状态**

```
systemctl status docker
```

![image-20200916143238016](https://blog-1302755396.cos.ap-shanghai.myqcloud.com/blog/20200917152603.png)

### 2.docker 使用

1. 查看容器状态

   ```
   docker ps -a
   ```

2. 启动指定容器

   ```
   docker start [CONTAINER ID]
   ```

   

